<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Guided solution (page 2) :: Red Hat OpenStack Networking: Break-fix Practice - Diagnosing Destination Host Unreachable and No Route to Host Errors</title>
    <link rel="prev" href="section1.html">
    <link rel="next" href="../chapter3/summary.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Red Hat OpenStack Networking: Break-fix Practice - Diagnosing Destination Host Unreachable and No Route to Host Errors</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhosp-bfx-019" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Red Hat OpenStack Networking: Break-fix Practice - Diagnosing Destination Host Unreachable and No Route to Host Errors</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Red Hat OpenStack Platform: Break-fix Practice - Diagnosing Destination Host Unreachable and No Route to Host Errors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter1/index.html">Whatâ€™s in this break-fix?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/section1.html">Break-fix activity</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/section2.html">Check your work</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/section3.html">Break-fix Scenario</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Guided solution</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section1.html">Guided solution (page 1)</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="section2.html">Guided solution (page 2)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter3/summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Red Hat OpenStack Networking: Break-fix Practice - Diagnosing Destination Host Unreachable and No Route to Host Errors</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Red Hat OpenStack Networking: Break-fix Practice - Diagnosing Destination Host Unreachable and No Route to Host Errors</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Red Hat OpenStack Networking: Break-fix Practice - Diagnosing Destination Host Unreachable and No Route to Host Errors</a></li>
    <li><a href="index.html">Guided solution</a></li>
    <li><a href="section2.html">Guided solution (page 2)</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Guided solution (page 2)</h1>
<div id="preamble">
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Determine tap interface used for the instance on the compute node.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>(overcloud) [stack@director ~]$ openstack port list --server scenario-bfx019-vm
-------------------------------------------------------------------------------------------------------------------------------------------------------
| ID                                   | Name | MAC Address       | Fixed IP Addresses                                                             | Status |
-------------------------------------------------------------------------------------------------------------------------------------------------------
| a98210f2-23d4-4f5d-ba0e-7abdd0ae5866 |      | fa:16:3e:6e:88:d5 | ip_address='192.168.110.169', subnet_id='00db31a6-9f47-4983-b2c3-40f0c2cc6f95' | ACTIVE |
-------------------------------------------------------------------------------------------------------------------------------------------------------</p>
</div>
</blockquote>
</div>
</li>
<li>
<p>Run below command on the compute node to view the tap device.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-novacompute-1 ~]# ip link show tapa98210f2-23
18: tapa98210f2-23: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1442 qdisc noqueue master ovs-system state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether fe:16:3e:6e:88:d5 brd ff:ff:ff:ff:ff:ff
[root@overcloud-novacompute-1 ~]#</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Note how tap device&#8217;s name is derived by appending "tap" to the initial string from the port ID.</p>
</div>
</li>
<li>
<p>Execute a tcpdump on this tap interface on attempting to ping the instance.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-novacompute-1 ~]# tcpdump -envvi tapa98210f2-23
dropped privs to tcpdump
tcpdump: listening on tapa98210f2-23, link-type EN10MB (Ethernet), snapshot length 262144 bytes</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You see that on ICMP echo requests are visible on the external NIC, they are not being delivered to the instance (via tap interface). The issue seems to be occurring within the br-int bridge where packets appear to be lost.</p>
</div>
</li>
<li>
<p>To capture a single ICMP request packet on the external interface using tcpdump. Save this captured packet to a file. Run the following command on compute node and ping the instance from director node so that a packet is sent and eventually captured and saved into the file icmp-request.pcap.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-novacompute-1 ~]# tcpdump -i ens4 icmp -c1 -w icmp-request.pcap
dropped privs to tcpdump
tcpdump: listening on ens4, link-type EN10MB (Ethernet), snapshot length 262144 bytes
1 packet captured
1 packet received by filter
0 packets dropped by kernel</p>
</div>
</blockquote>
</div>
</li>
<li>
<p>Verify the generated file content by reading back the stored packet using tcpdump command.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-novacompute-1 ~]# tcpdump -r icmp-request.pcap
reading from file icmp-request.pcap, link-type EN10MB (Ethernet), snapshot length 262144
dropped privs to tcpdump
12:36:59.513450 IP serverb.lab.example.com &gt; 172.25.250.203: ICMP echo request, id 4, seq 1, length 64</p>
</div>
</blockquote>
</div>
</li>
<li>
<p>Use the ovs-pcap tool to read and display the packets from the stored icmp-request.pcap file.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-novacompute-1 ~]# ovs-pcap icmp-request.pcap
fa163e6ce64552540004fa0b080045000054932b400040015a73ac19fa0bac19facb0800820800040001ebe3f66500000000cdd5070000000000101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f3031323334353637</p>
</div>
</blockquote>
</div>
</li>
<li>
<p>Identify the OpenFlow number corresponding to the external network interface (ens4). This is important for later tracing.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-novacompute-1 ~]# ovs-ofctl show br-ex
OFPT_FEATURES_REPLY (xid=0x2): dpid:000052540001fa1f
n_tables:254, n_buffers:0
capabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP
actions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst mod_nw_tos mod_tp_src mod_tp_dst
 1(ens4): addr:52:54:00:01:fa:1f
     config:     0
     state:      0
     speed: 0 Mbps now, 0 Mbps max
 3(patch-provnet-a): addr:72:48:45:5c:37:28
     config:     0
     state:      0
     speed: 0 Mbps now, 0 Mbps max
 LOCAL(br-ex): addr:52:54:00:01:fa:1f
     config:     0
     state:      0
     speed: 0 Mbps now, 0 Mbps max
OFPT_GET_CONFIG_REPLY (xid=0x4): frags=normal miss_send_len=0</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The interface ens4 is port 1 as denoted by 1(ens4) in the above output.</p>
</div>
</li>
<li>
<p>Use the identified OpenFlow number to trace the packet flow using the ovs-appctl command with the proto/trace tool.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-novacompute-1 ~]# ovs-appctl ofproto/trace br-ex in_port=1 $(ovs-pcap icmp-request.pcap) | less
Flow: icmp,in_port=1,vlan_tci=0x0000,dl_src=52:54:00:04:fa:0b,dl_dst=fa:16:3e:6c:e6:45,nw_src=172.25.250.11,nw_dst=172.25.250.203,nw_tos=0,nw_ecn=0,nw_ttl=64,nw_frag=no,icmp_type=8,icmp_code=0</p>
</div>
<div class="paragraph">
<p>bridge("br-ex")</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>priority 0
NORMAL
 &#8594; forwarding to learned port</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>bridge("br-int")</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>in_port=14,vlan_tci=0x0000/0x1000, priority 100, cookie 0xac0b8c60
set_field:0x1&#8594;reg13
set_field:0x8&#8594;reg11
set_field:0x9&#8594;reg12
set_field:0x1&#8594;metadata
set_field:0x1&#8594;reg14
resubmit(,8)</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>. .</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>As observed in the provided snippet, the packet trajectory involves passing through the br-ex bridge and utilizing the flow table 0.</p>
</li>
<li>
<p>In this context, the process involves regular switching operations.</p>
</li>
<li>
<p>The packet journey leads it to be forwarded to the br-int bridge.</p>
</li>
<li>
<p>This action is facilitated via the in_port=14 (this might differ in your output), which corresponds to the patch port connecting br-ex and br-int.</p>
</li>
</ul>
</div>
</li>
<li>
<p>We can now run the same command with in_port=14 and pass the packet to br-int this time.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-novacompute-1 ~]# ovs-appctl ofproto/trace br-int in_port=14 $(ovs-pcap icmp-request.pcap) | less
Flow: icmp,in_port=14,vlan_tci=0x0000,dl_src=52:54:00:04:fa:0b,dl_dst=fa:16:3e:6c:e6:45,nw_src=172.25.250.11,nw_dst=172.25.250.203,nw_tos=0,nw_ecn=0,nw_ttl=64,nw_frag=no,icmp_type=8,icmp_code=0</p>
</div>
<div class="paragraph">
<p>bridge("br-int")</p>
</div>
<div class="listingblock">
<div class="content">
<pre> 0. in_port=14,vlan_tci=0x0000/0x1000, priority 100, cookie 0xac0b8c60
    set_field:0x1-&gt;reg13
    set_field:0x8-&gt;reg11
    set_field:0x9-&gt;reg12
    set_field:0x1-&gt;metadata
    set_field:0x1-&gt;reg14
    resubmit(,8)
 8. metadata=0x1, priority 50, cookie 0x9a9fa56d
    set_field:0/0x1000-&gt;reg10
    resubmit(,73)
    73. No match.
            drop</pre>
</div>
</div>
</blockquote>
</div>
</li>
<li>
<p>Understand the significance of the metadata and reg14 fields in the tracing output. Metadata represents the datapath ID, and reg14 holds the identifier of the port in the Port_Bindings table.</p>
<div class="quoteblock">
<blockquote>
<div class="literalblock">
<div class="content">
<pre>set_field:0x1-&gt;metadata
set_field:0x1-&gt;reg14</pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Datapath in OVN represents a logical entity which can either be a switch or a router.</p>
</div>
</li>
<li>
<p>Log in to the controller node from the director machine and list the datapath bindings.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>(overcloud) [stack@director ~]$ ssh tripleo-admin@overcloud-control0
Register this system with Red Hat Insights: insights-client --register
Create an account or view all your systems at <a href="https://red.ht/insights-dashboard" class="bare">https://red.ht/insights-dashboard</a>
Last login: Mon Feb  5 10:46:00 2024 from 172.25.249.11
[tripleo-admin@overcloud-controller-0 ~]$ sudo -i</p>
</div>
<div class="paragraph">
<p>[root@overcloud-controller-0 ~]# alias ovn-sbctl="podman exec -it ovn_cluster_south_db_server ovn-sbctl --no-leader"</p>
</div>
<div class="paragraph">
<p>[root@overcloud-controller-0 ~]# ovn-sbctl list datapath_binding
_uuid               : 1dbd6691-a5f0-43c6-b6e0-34830fdd6ae7
external_ids        : {logical-switch="7c8d5e07-28b1-40ad-aeab-1c4cf6855394", name=neutron-83c029f9-acb1-49ac-9858-d27dd6de9e8e, name2=scenario-bfx019-network}
load_balancers      : []
tunnel_key          : 2</p>
</div>
<div class="paragraph">
<p>_uuid               : 1651fee6-6cb7-48f8-8187-61880301b417
external_ids        : {always_learn_from_arp_request="false", logical-router="2e5bd12d-b3ea-4ecd-946b-3941298d05cd", name=neutron-721c2d03-8830-42f6-9a18-2a13554f2417, name2=scenario-bfx019-router}
load_balancers      : []
tunnel_key          : 3</p>
</div>
<div class="paragraph">
<p>_uuid               : c5658f8b-b13d-4527-a4e8-3ae50384c3e8
external_ids        : {logical-switch="a889db9c-4c73-482b-827e-371633be9d1e", name=neutron-5a22357d-9774-4774-a52d-6cff9be904d2, name2=public}
load_balancers      : []
tunnel_key          : 1</p>
</div>
<div class="paragraph">
<p>Match the tunnel key with the Datapath_Binding table to identify the logical switch (datapath) associated with the packet.</p>
</div>
<div class="paragraph">
<p>[root@overcloud-controller-0 ~]# ovn-sbctl find datapath_binding tunnel_key=1
_uuid               : c5658f8b-b13d-4527-a4e8-3ae50384c3e8
external_ids        : {logical-switch="a889db9c-4c73-482b-827e-371633be9d1e", name=neutron-5a22357d-9774-4774-a52d-6cff9be904d2, name2=public}
load_balancers      : []
tunnel_key          : 1</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The above output tunnel_key 1 is a logical switch which maps to the Neutron network id c5658f8b-b13d-4527-a4e8-3ae50384c3e8 and Neutron network name public. A Logical switch in OVN is a network in Neutron. Hence datapath 1 is the public switch in OVN.</p>
</div>
</li>
<li>
<p>By searching for the Port_Binding that contains the datapath of interest, it is possible to determine the incoming port that holds this key. This combination of the tunnel key and the associated datapath (identified through _uuid) uniquely identifies the port within the network environment.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-controller-0 ~]# ovn-sbctl find Port_Binding datapath=c5658f8b-b13d-4527-a4e8-3ae50384c3e8 | less</p>
</div>
</blockquote>
</div>
</li>
<li>
<p>Look for the port binding that has tunnel key 1 in the output of the above command.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&#8230;&#8203;
_uuid               : ac0b8c60-b105-41e4-873b-02299eecdc74
additional_chassis  : []
additional_encap    : []
chassis             : []
datapath            : c5658f8b-b13d-4527-a4e8-3ae50384c3e8
encap               : []
external_ids        : {}
gateway_chassis     : []
ha_chassis_group    : []
logical_port        : provnet-a6756553-bb34-4818-bb2c-057a04cb5dac
mac                 : [unknown]
mirror_rules        : []
nat_addresses       : []
options             : {localnet_learn_fdb="false", mcast_flood="false", mcast_flood_reports="true", network_name=datacentre}
parent_port         : []
port_security       : []
requested_additional_chassis: []
requested_chassis   : []
tag                 : []
tunnel_key          : 1
type                : localnet
up                  : false
virtual_parent      : []
. . .</p>
</div>
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>This means the incoming port is the port with tunnel key 1 on data path c5658f8b-b13d-4527-a4e8-3ae50384c3e8.</p>
</li>
<li>
<p>These two numbers uniquely identify the port in the environment.</p>
</li>
<li>
<p>We can now see how the packet is being processed in the pipeline.</p>
</li>
<li>
<p>Re-run the previous ovs-appctl command and scroll through the output.</p>
</li>
<li>
<p>The metadata field would be changed (0x3 in the below output but it could be different for you) as the packet would be going through different logical entities in the network.</p>
</li>
<li>
<p>Scroll down and see the NAT rule applied which does the conversion from floating ip to fixed ip.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-novacompute-1 ~]# ovs-appctl ofproto/trace br-int in_port=14 $(ovs-pcap icmp-request.pcap) | less
. . .
    set_field:0x3&#8594;metadata
. . .
bridge("br-int")</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    thaw
        Resuming from table 13
13. metadata=0x3, priority 0, cookie 0xe8a1c4df
    resubmit(,14)
14. metadata=0x3, priority 0, cookie 0x5ea050c8
    resubmit(,15)
15. ip,reg14=0x1,metadata=0x3,nw_dst=172.25.250.203, priority 100, cookie 0x52460715
    ct(commit,table=16,zone=NXM_NX_REG11[0..15],nat(dst=192.168.110.169))
    nat(dst=192.168.110.169)
     -&gt; A clone of the packet is forked to recirculate. The forked pipeline will be resumed at table 16.
     -&gt; Sets the packet to an untracked state, and clears all the conntrack fields.
. . .</pre>
</div>
</div>
</blockquote>
</div>
</li>
<li>
<p>Continue to scroll down and observe the drop rule on table 44</p>
<div class="quoteblock">
<blockquote>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ip,reg0=0x1/0x1,metadata=0x2, priority 100, cookie 0xc15982ac
        ct(table=45,zone=NXM_NX_REG13[0..15])
        drop
         &#8594; A clone of the packet is forked to recirculate. The forked pipeline will be resumed at table 45.
         &#8594; Sets the packet to an untracked state, and clears all the conntrack fields.
pop:NXM_OF_IN_PORT[]
 &#8594; NXM_OF_IN_PORT[] is now 14</p>
</li>
</ol>
</div>
</blockquote>
</div>
</li>
<li>
<p>Continue to scroll till the end and observe the final rule with the drop action at table 46.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>+
46. ip,reg0=0x200/0x200,reg15=0x3,metadata=0x2, priority 2001, cookie 0x93e2a6e9
    drop</p>
</div>
<div class="paragraph">
<p>Final flow: recirc_id=0x4d,ct_state=new|trk,ct_zone=3,eth,icmp,reg0=0x281,reg11=0x5,reg12=0x6,reg13=0x3,reg14=0x2,reg15=0x3,metadata=0x2,in_port=ANY,vlan_tci=0x0000,dl_src=fa:16:3e:bb:69:f5,dl_dst=fa:16:3e:6e:88:d5,nw_src=172.25.250.11,nw_dst=192.168.110.169,nw_tos=0,nw_ecn=0,nw_ttl=63,nw_frag=no,icmp_type=8,icmp_code=0
Megaflow: recirc_id=0x4d,ct_state=+new-est-rel-rpl-inv+trk,ct_mark=0/0x1,eth,ip,in_port=ANY,dl_src=fa:16:3e:bb:69:f5,nw_frag=no
Datapath actions: drop</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The cookie value, in this case, 0x93e2a6e9, is significant as it represents a logical flow within OVN. Logical flows are internal constructs within the Southbound database that describe how packets would be processed within the OVN infrastructure. These logical flows serve as the basis upon which actual OpenFlows are constructed and enforced.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>To continue investigating, return to the OVN controller and request a listing of the Southbound logical flows.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>[root@overcloud-controller-0 ~]# ovn-sbctl list Logical_Flow | less</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In the list of logical flows, search for the cookie value noted earlier but without the leading 0x (in this case, 93e2a6e9). This allows you to pinpoint the specific logical flow associated with the packet in question.</p>
</div>
</li>
<li>
<p>Note that the logical flow includes references to a flow uuid that ties back to the previously identified cookie.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>_uuid               : 93e2a6e9-4b93-4a32-b8b4-5e6cdf2766bd
actions             : "/* drop /"
controller_meter    : []
external_ids        : {source="northd.c:6512", stage-hint=f26cdac9, stage-name=*ls_out_acl}
logical_datapath    : 1dbd6691-a5f0-43c6-b6e0-34830fdd6ae7
logical_dp_group    : []
match               : "reg0[9] == 1 &amp;&amp; (outport == @neutron_pg_drop &amp;&amp; ip)"
pipeline            : egress
priority            : 2001
table_id            : 4
tags                : {}
hash                : 0</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Observe the stage-name=ls_out_acl parameter within the logical flow. This indicates that the logical flow resides in the stage called "logical switch out acl." In the context of OVN, ACLs (Access Control Lists) play a crucial role in implementing security groups. The specific logical flow being examined appears to relate to egress traffic, as indicated by the pipeline designation: egress. Additionally, the match parameter points to the condition outport neutron_pg_drop &amp;&amp; ip, specifying that the action is to drop packets. It is important to understand that neutron_pg_drop refers to an internal concept in Neutron, which is the networking component in OpenStack. This signifies that packets matching this condition are dropped by default. Within Neutron, to allow specific traffic through a security group, you must define rules that explicitly let it. If no such rules exist, traffic would be subject to default actions like the one represented by neutron_pg_drop, resulting in packet drops.</p>
</div>
</li>
<li>
<p>To further investigate the issue, list the ports associated with the instance and run openstack port show on the relevant port ID. This step provides insight into the specific ports, their configurations, and their associated security groups, which is critical for resolving the packet drop issue.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>(overcloud) [stack@director ~]$ openstack port list --server scenario-bfx019-vm
-------------------------------------------------------------------------------------------------------------------------------------------------------
| ID                                   | Name | MAC Address       | Fixed IP Addresses                                                             | Status |
-------------------------------------------------------------------------------------------------------------------------------------------------------
| a98210f2-23d4-4f5d-ba0e-7abdd0ae5866 |      | fa:16:3e:6e:88:d5 | ip_address='192.168.110.169', subnet_id='00db31a6-9f47-4983-b2c3-40f0c2cc6f95' | ACTIVE |
-------------------------------------------------------------------------------------------------------------------------------------------------------
(overcloud) [stack@director ~]$
(overcloud) [stack@director ~]$ openstack port show a98210f2-23d4-4f5d-ba0e-7abdd0ae5866
-------------------------------------------------------------------------------------------------------------------------------------+
| Field                   | Value                                                                                                      |
-------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up          | UP                                                                                                         |
| allowed_address_pairs   |                                                                                                            |
| binding_host_id         | overcloud-novacompute-1.localdomain                                                                        |
| binding_profile         |                                                                                                            |
| binding_vif_details     | connectivity='l2', port_filter='True'                                                                      |
| binding_vif_type        | ovs                                                                                                        |
| binding_vnic_type       | normal                                                                                                     |
| created_at              | 2024-03-17T11:45:49Z                                                                                       |
| data_plane_status       | None                                                                                                       |
| description             |                                                                                                            |
| device_id               | 46d5b896-afdb-4606-8702-5ba7cd6ae069                                                                       |
| device_owner            | compute:nova                                                                                               |
| device_profile          | None                                                                                                       |
| dns_assignment          | fqdn='host-192-168-110-169.openstacklocal.', hostname='host-192-168-110-169', ip_address='192.168.110.169' |
| dns_domain              |                                                                                                            |
| dns_name                |                                                                                                            |
| extra_dhcp_opts         |                                                                                                            |
| fixed_ips               | ip_address='192.168.110.169', subnet_id='00db31a6-9f47-4983-b2c3-40f0c2cc6f95'                             |
| id                      | a98210f2-23d4-4f5d-ba0e-7abdd0ae5866                                                                       |
| ip_allocation           | immediate                                                                                                  |
| mac_address             | fa:16:3e:6e:88:d5                                                                                          |
| name                    |                                                                                                            |
| network_id              | 83c029f9-acb1-49ac-9858-d27dd6de9e8e                                                                       |
| numa_affinity_policy    | None                                                                                                       |
| port_security_enabled   | True                                                                                                       |
| project_id              | 0192bf49efca46bf932847c75117578e                                                                           |
| propagate_uplink_status | None                                                                                                       |
| qos_network_policy_id   | None                                                                                                       |
| qos_policy_id           | None                                                                                                       |
| resource_request        | None                                                                                                       |
| revision_number         | 4                                                                                                          |
| security_group_ids      | c04338d6-18ff-4a3b-8287-3dab827fd846                                                                       |
| status                  | ACTIVE                                                                                                     |
| tags                    |                                                                                                            |
| trunk_details           | None                                                                                                       |
| updated_at              | 2024-03-17T11:45:50Z                                                                                       |
----------------------------------</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>As observed, the port associated with the instance has the port_security_enabled flag set to true. This signifies that port security mechanisms are active, enhancing the overall security of the network environment.</p>
</div>
</li>
<li>
<p>Pay attention to the security_group_ids field in the port&#8217;s output. This field contains references to the associated security groups that govern the traffic allowed to and from the instance.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>(overcloud) [stack@director ~]$ openstack security group show c04338d6-18ff-4a3b-8287-3dab827fd846
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field           | Value                                                                                                                                                                         |
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| created_at      | 2024-03-17T11:45:40Z                                                                                                                                                          |
| description     | scenario-bfx019-sg                                                                                                                                                            |
| id              | c04338d6-18ff-4a3b-8287-3dab827fd846                                                                                                                                          |
| name            | scenario-bfx019-sg                                                                                                                                                            |
| project_id      | 0192bf49efca46bf932847c75117578e                                                                                                                                              |
| revision_number | 1                                                                                                                                                                             |
| rules           | created_at='2024-03-17T11:45:40Z', direction='egress', ethertype='IPv6', id='2a70fb1a-cf79-46ed-8b11-0447065caa3a', standard_attr_id='110', updated_at='2024-03-17T11:45:40Z' |
|                 | created_at='2024-03-17T11:45:40Z', direction='egress', ethertype='IPv4', id='4d21a1c5-1431-4f6a-9b4e-2e58120acebe', standard_attr_id='107', updated_at='2024-03-17T11:45:40Z' |
| stateful        | True                                                                                                                                                                          |
| tags            | []                                                                                                                                                                            |
| updated_at      | 2024-03-17T11:45:40Z                                                                                                                                                          |
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Upon inspecting the rules of the associated security group, it becomes evident that the current rules primarily let egress traffic. However, in this case, the instance requires ingress traffic access for both SSH and ICMP, which is lacking in the existing ruleset. The absence of rules allowing this specific ingress traffic results in the drop of the incoming packets.</p>
</div>
</li>
<li>
<p>The resolution involves adding the necessary rules to the security group let the required SSH and ICMP traffic. These rules would specify the allowed protocols, ports, and sources/destinations for the traffic.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>(overcloud) [stack@director ~]$ openstack security group rule create --ingress --protocol icmp c04338d6-18ff-4a3b-8287-3dab827fd846
---------------------------------------------------------------+
| Field                   | Value                                |
---------------------------------------------------------------+
| created_at              | 2024-03-17T14:58:10Z                 |
| description             |                                      |
| direction               | ingress                              |
| ether_type              | IPv4                                 |
| id                      | 0b90fe85-52bc-4767-8ae3-866e4a3cce02 |
| name                    | None                                 |
| port_range_max          | None                                 |
| port_range_min          | None                                 |
| project_id              | 0192bf49efca46bf932847c75117578e     |
| protocol                | icmp                                 |
| remote_address_group_id | None                                 |
| remote_group_id         | None                                 |
| remote_ip_prefix        | 0.0.0.0/0                            |
| revision_number         | 0                                    |
| security_group_id       | c04338d6-18ff-4a3b-8287-3dab827fd846 |
| tags                    | []                                   |
| updated_at              | 2024-03-17T14:58:10Z                 |
---------------------------------------------------------------+</p>
</div>
<div class="paragraph">
<p>(overcloud) [stack@director ~]$ openstack security group rule create --ingress --protocol tcp --dst-port 22 c04338d6-18ff-4a3b-8287-3dab827fd846
---------------------------------------------------------------+
| Field                   | Value                                |
---------------------------------------------------------------+
| created_at              | 2024-03-17T14:58:55Z                 |
| description             |                                      |
| direction               | ingress                              |
| ether_type              | IPv4                                 |
| id                      | 52e01d25-808e-4cad-968d-c54d348a2523 |
| name                    | None                                 |
| port_range_max          | 22                                   |
| port_range_min          | 22                                   |
| project_id              | 0192bf49efca46bf932847c75117578e     |
| protocol                | tcp                                  |
| remote_address_group_id | None                                 |
| remote_group_id         | None                                 |
| remote_ip_prefix        | 0.0.0.0/0                            |
| revision_number         | 0                                    |
| security_group_id       | c04338d6-18ff-4a3b-8287-3dab827fd846 |
| tags                    | []                                   |
| updated_at              | 2024-03-17T14:58:55Z                 |
---------------------------------------------------------------+</p>
</div>
</blockquote>
</div>
</li>
<li>
<p>After making the necessary rule adjustments, test the connectivity by attempting ICMP ping and SSH access to the instance. Verify that these actions are successful, indicating that the added security group rules are now permitting the desired traffic.</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>(overcloud) [stack@director ~]$ ping -c 1 172.25.250.203
PING 172.25.250.203 (172.25.250.203) 56(84) bytes of data.
64 bytes from 172.25.250.203: icmp_seq=1 ttl=63 time=4.86 ms</p>
</div>
<div class="paragraph">
<p>--- 172.25.250.203 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 4.864/4.864/4.864/0.000 ms</p>
</div>
<div class="paragraph">
<p>(overcloud) [stack@director ~]$ ssh -i /home/stack/osp_training/.scenario1/scenario-1-key.pem cirros@172.25.250.203
Warning: Identity file /home/stack/osp_training/.scenario1/scenario-1-key.pem not accessible: No such file or directory.
Warning: Permanently added '172.25.250.203' (ECDSA) to the list of known hosts.
cirros@172.25.250.203&#8217;s password:
$
$ cat /etc/cirros/version
0.5.2</p>
</div>
</blockquote>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_evaluation"><a class="anchor" href="#_evaluation"></a>Evaluation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As the stack user on the director machine, use the lab command to grade your work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[stack@director ~]$ lab grade bfx019</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Provide the gocubsgo as a password if prompted by the grade action.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_finish"><a class="anchor" href="#_finish"></a>Finish</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the lab finish command to complete this exercise. This step is important to ensure that resources from current exercises do not impact upcoming exercises.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[stack@director ~]$ lab finish bfx019</pre>
</div>
</div>
<div class="paragraph">
<p>This concludes the section.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="section1.html">Guided solution (page 1)</a></span>
  <span class="next"><a href="../chapter3/summary.html">Summary</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
